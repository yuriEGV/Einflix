"use strict";(()=>{var e={};e.id=351,e.ids=[351],e.modules={11185:e=>{e.exports=require("mongoose")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},96309:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>g,originalPathname:()=>b,requestAsyncStorage:()=>y,routeModule:()=>d,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>h});var r={};a.r(r),a.d(r,{GET:()=>GET,POST:()=>POST,dynamic:()=>c}),a(78976);var n=a(10884),u=a(16132),i=a(38258),s=a(71409),o=a(11185);let p=new o.Schema({userId:{type:o.Schema.Types.ObjectId,ref:"User",required:!0},externalReference:String,amount:Number,currency:{type:String,default:"CLP"},planType:{type:String,enum:["total","medium","basic"],required:!0},duration:{type:String,enum:["monthly","yearly"],required:!0},status:{type:String,default:"pending"},paymentDate:{type:Date,default:Date.now}},{timestamps:!0}),l=o.models.Payment||o.model("Payment",p),c="force-dynamic";async function GET(e){try{await (0,i.default)();let{searchParams:t}=new URL(e.url),a=t.get("status"),r=t.get("external_reference");if("approved"!==a||!r)return Response.redirect(new URL("/payment?status=failed",e.url));{let[t,a,n]=r.split("|"),u=new Date;return"yearly"===n?u.setFullYear(u.getFullYear()+1):u.setMonth(u.getMonth()+1),await s.default.findByIdAndUpdate(t,{isPaid:!0,planType:a||"basic",subscriptionExpiry:u}),await l.create({userId:t,externalReference:r,amount:0,planType:a||"basic",duration:n||"monthly",status:"approved"}),Response.redirect(new URL("/gallery?payment=success",e.url))}}catch(t){return console.error("Error Callback:",t.message),Response.redirect(new URL("/payment?status=error",e.url))}}async function POST(e){return GET(e)}let d=new n.AppRouteRouteModule({definition:{kind:u.x.APP_ROUTE,page:"/api/auth/payment/callback/route",pathname:"/api/auth/payment/callback",filename:"route",bundlePath:"app/api/auth/payment/callback/route"},resolvedPagePath:"C:\\einflix\\app\\api\\auth\\payment\\callback\\route.js",nextConfigOutput:"",userland:r}),{requestAsyncStorage:y,staticGenerationAsyncStorage:m,serverHooks:f,headerHooks:g,staticGenerationBailout:h}=d,b="/api/auth/payment/callback/route"}};var t=require("../../../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),a=t.X(0,[364,764,258,409],()=>__webpack_exec__(96309));module.exports=a})();