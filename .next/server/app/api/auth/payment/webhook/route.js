"use strict";(()=>{var e={};e.id=980,e.ids=[980],e.modules={11185:e=>{e.exports=require("mongoose")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},71017:e=>{e.exports=require("path")},85477:e=>{e.exports=require("punycode")},63477:e=>{e.exports=require("querystring")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},38834:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>x,originalPathname:()=>h,requestAsyncStorage:()=>c,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>y,staticGenerationBailout:()=>f});var a={};r.r(a),r.d(a,{POST:()=>POST,dynamic:()=>l}),r(78976);var o=r(10884),s=r(16132),n=r(38258),i=r(71409),p=r(35462),u=r(55415);let l="force-dynamic";async function POST(e){try{let{searchParams:t}=new URL(e.url),r=t.get("topic")||t.get("type"),a=t.get("id")||t.get("data.id");if(console.log(`WEBHOOK RECEIVED: Topic: ${r}, ID: ${a}`),"payment"===r){if(!a)return new Response("Missing payment ID",{status:400});let e=await u.payment.findById(Number(a));if(!e||!e.body)return new Response("Payment not found",{status:404});let t=e.body,r=t.external_reference,o=t.status;if(console.log(`WEBHOOK PAYLOAD: Status: ${o}, Ref: ${r}`),"approved"===o&&r){await (0,n.default)();let e=await p.Z.findOne({paymentId:String(a)});if(e)return console.log(`WEBHOOK: Payment ${a} already processed.`),new Response("Already processed",{status:200});let[s,u,l]=r.split("|"),d=new Date;"yearly"===l?d.setFullYear(d.getFullYear()+1):d.setMonth(d.getMonth()+1),await i.default.findByIdAndUpdate(s,{isPaid:!0,planType:u||"basic",subscriptionExpiry:d}),await p.Z.create({userId:s,externalReference:r,paymentId:String(a),amount:t.transaction_amount,paymentMethod:t.payment_method_id,planType:u||"basic",duration:l||"monthly",status:o}),console.log(`WEBHOOK: Payment ${a} processed successfully.`)}}return new Response("OK",{status:200})}catch(e){return console.error("WEBHOOK ERROR:",e),new Response("Internal Server Error",{status:500})}}u.configure({access_token:(process.env.MP_ACCESS_TOKEN||"").trim()});let d=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/auth/payment/webhook/route",pathname:"/api/auth/payment/webhook",filename:"route",bundlePath:"app/api/auth/payment/webhook/route"},resolvedPagePath:"C:\\einflix\\app\\api\\auth\\payment\\webhook\\route.js",nextConfigOutput:"",userland:a}),{requestAsyncStorage:c,staticGenerationAsyncStorage:y,serverHooks:m,headerHooks:x,staticGenerationBailout:f}=d,h="/api/auth/payment/webhook/route"}};var t=require("../../../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[364,764,415,258,409,462],()=>__webpack_exec__(38834));module.exports=r})();